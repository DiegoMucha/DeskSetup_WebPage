<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8">
    <title>Carrito de Compras - DeskSetup Pro</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="./css/styles-carrito-register.css">
    <link rel="stylesheet" href="css/style-footer.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
</head>

<body>
    <!--Nav Bar-->
    <iframe src="navbar.html" width="100%" height="85" style="border:none; overflow:hidden;"></iframe>

    <!-- Contenido del Carrito -->
    <div class="container">
        <h1 class="text-center mt-5 mb-5">Carrito de compras</h1>

        <div class="table-responsive">
            <table class="table">
                <thead>
                    <tr>
                        <th>Producto</th>
                        <th>Precio</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody id="carrito-items">
                    <!-- Los items se cargarán dinámicamente -->
                </tbody>
            </table>
        </div>

        <div class="total text-end">
            <p>Total: $<span id="carrito-total">0</span></p>
            <button class="btn btn-primary continuar mb-5 mt-5" onclick="finalizarCompra()">Continuar compra</button>
        </div>
    </div>
    <!-- Add this modal before the footer -->
    <div class="modal fade" id="pagoModal" tabindex="-1" aria-labelledby="pagoModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="pagoModalLabel">Información de Pago</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="formPago">
                        <div class="mb-3">
                            <label for="nombreTarjeta" class="form-label">Nombre en la tarjeta</label>
                            <input type="text" class="form-control" id="nombreTarjeta" required>
                        </div>
                        <div class="mb-3">
                            <label for="numeroTarjeta" class="form-label">Número de tarjeta</label>
                            <input type="text" 
                                   class="form-control" 
                                   id="numeroTarjeta" 
                                   required 
                                   maxlength="19"
                                   placeholder="1234 5678 9012 3456">
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="fechaExpiracion" class="form-label">Fecha de expiración</label>
                                <input type="text" class="form-control" id="fechaExpiracion" required 
                                       pattern="(0[1-9]|1[0-2])\/([0-9]{2})" placeholder="MM/YY">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="cvv" class="form-label">CVV</label>
                                <input type="text" class="form-control" id="cvv" required 
                                       pattern="[0-9]{3,4}" maxlength="4" placeholder="123">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="metodoPago" class="form-label">Método de pago</label>
                            <select class="form-select" id="metodoPago" required>
                                <option value="">Seleccione un método</option>
                                <option value="visa">Visa</option>
                                <option value="mastercard">Mastercard</option>
                                <option value="american">American Express</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="procesarPago()">Pagar $<span id="modalTotal">0</span></button>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <iframe src="footer.html" width="100%" height="130px" style="border:none;"></iframe>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Cargar productos del carrito
        function cargarCarrito() {
            const carrito = JSON.parse(localStorage.getItem('carrito')) || [];
            const contenedor = document.getElementById('carrito-items');
            const totalElement = document.getElementById('carrito-total');
            let total = 0;

            contenedor.innerHTML = '';

            carrito.forEach((producto, index) => {
                total += parseFloat(producto.precio);
                contenedor.innerHTML += `
                    <tr>
                        <td>
                            <img src="${producto.imagen_url}" alt="${producto.nombre}" class="img-thumbnail" style="width: 100px">
                            ${producto.nombre}
                        </td>
                        <td>$${producto.precio}</td>
                        <td>
                            <button onclick="eliminarDelCarrito(${index})" class="btn btn-danger">
                                <i class="fas fa-trash"></i> Eliminar
                            </button>
                        </td>
                    </tr>
                `;
            });

            totalElement.textContent = total.toFixed(2);
        }

        // Eliminar producto del carrito
        function eliminarDelCarrito(index) {
            let carrito = JSON.parse(localStorage.getItem('carrito')) || [];
            carrito.splice(index, 1);
            localStorage.setItem('carrito', JSON.stringify(carrito));
            cargarCarrito();
        }

        // Finalizar compra
        function finalizarCompra() {
            const total = document.getElementById('carrito-total').textContent;
            document.getElementById('modalTotal').textContent = total;
            const pagoModal = new bootstrap.Modal(document.getElementById('pagoModal'));
            pagoModal.show();
        }

        // Add new procesarPago function
        function procesarPago() {
            const formPago = document.getElementById('formPago');
            if (!formPago.checkValidity()) {
                formPago.reportValidity();
                return;
            }

            const datosPago = {
                nombreTarjeta: document.getElementById('nombreTarjeta').value,
                numeroTarjeta: document.getElementById('numeroTarjeta').value,
                fechaExpiracion: document.getElementById('fechaExpiracion').value,
                cvv: document.getElementById('cvv').value,
                metodoPago: document.getElementById('metodoPago').value,
                total: document.getElementById('modalTotal').textContent,
                productos: JSON.parse(localStorage.getItem('carrito')) || []
            };

            // Here we'll add the API call to process payment later
            console.log('Procesando pago:', datosPago);
            alert('¡Pago procesado con éxito!');
            localStorage.removeItem('carrito');
            location.reload();
        }

        // Add input formatting
        document.addEventListener('DOMContentLoaded', function() {
            cargarCarrito();

            document.getElementById('numeroTarjeta').addEventListener('input', function(e) {
                // Remove any non-digit characters
                let value = e.target.value.replace(/\D/g, '');
                
                // Truncate to 16 digits
                value = value.substring(0, 16);
                
                // Add spaces every 4 digits
                value = value.replace(/(\d{4})(?=\d)/g, '$1 ');
                
                // Update input value
                e.target.value = value;
            });

            document.getElementById('fechaExpiracion').addEventListener('input', function(e) {
                e.target.value = e.target.value.replace(/\s/g, '')
                                .replace(/^(\d{2})(\d)/, '$1/$2')
                                .trim();
            });
        });
    </script>
</body>
</html>